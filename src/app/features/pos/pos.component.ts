import { Component, OnInit } from '@angular/core';
import { FormControl } from '@angular/forms';
import { debounceTime, distinctUntilChanged } from 'rxjs/operators';
import { MatSnackBar } from '@angular/material/snack-bar';
import { ProductService } from '../../core/services/product.service';
import { CustomerService } from '../../core/services/customer.service';
import { OrderService } from '../../core/services/order.service';
import { CompanyService } from '../../core/services/company.service';
import { ProductResponse } from '../../core/models/product.models';
import { CustomerResponse } from '../../core/models/customer.models';
import { OrderResponse, PaymentMethod } from '../../core/models/order.models';
import { CompanyResponse } from '../../core/models/company.models';

interface CartItem {
  product: ProductResponse;
  quantity: number;
  subtotal: number;
}

@Component({
  selector: 'app-pos',
  templateUrl: './pos.component.html',
  styleUrls: ['./pos.component.scss']
})
export class PosComponent implements OnInit {
  products: ProductResponse[] = [];
  customers: CustomerResponse[] = [];
  cart: CartItem[] = [];

  searchControl = new FormControl('');
  customerControl = new FormControl('');
  barcodeControl = new FormControl('');

  selectedCustomer: CustomerResponse | null = null;
  paymentMethod: PaymentMethod = 'CASH';
  discount = 0;
  loading = false;
  productsLoading = false;
  completedOrder: OrderResponse | null = null;
  company: CompanyResponse | null = null;

  paymentMethods: { value: PaymentMethod; label: string }[] = [
    { value: 'CASH', label: 'Cash' },
    { value: 'CREDIT_CARD', label: 'Credit Card' },
    { value: 'DEBIT_CARD', label: 'Debit Card' },
    { value: 'MOBILE_PAYMENT', label: 'Mobile Payment' }
  ];

  constructor(
    private productService: ProductService,
    private customerService: CustomerService,
    private orderService: OrderService,
    private companyService: CompanyService,
    private snackBar: MatSnackBar
  ) {}

  ngOnInit(): void {
    this.loadProducts();
    this.loadCustomers();
    this.companyService.get().subscribe({ next: res => { this.company = res.data ?? null; } });

    this.searchControl.valueChanges.pipe(
      debounceTime(350),
      distinctUntilChanged()
    ).subscribe(val => this.loadProducts(val || ''));

    this.barcodeControl.valueChanges.pipe(
      debounceTime(300),
      distinctUntilChanged()
    ).subscribe(barcode => {
      if (barcode && barcode.length > 3) this.lookupBarcode(barcode);
    });
  }

  loadProducts(search = ''): void {
    this.productsLoading = true;
    this.productService.getAll(search, undefined, 0, 50).subscribe({
      next: res => { this.products = res.data?.content || []; this.productsLoading = false; },
      error: () => { this.productsLoading = false; }
    });
  }

  loadCustomers(): void {
    this.customerService.getAll('', 0, 100).subscribe({
      next: res => { this.customers = res.data?.content || []; }
    });
  }

  lookupBarcode(barcode: string): void {
    this.productService.getByBarcode(barcode).subscribe({
      next: res => {
        if (res.data) {
          this.addToCart(res.data);
          this.barcodeControl.setValue('', { emitEvent: false });
        }
      },
      error: () => this.snackBar.open('Product not found for barcode: ' + barcode, 'Close', { duration: 3000 })
    });
  }

  addToCart(product: ProductResponse): void {
    if (product.quantity <= 0) {
      this.snackBar.open(`${product.name} is out of stock`, 'Close', { duration: 3000 });
      return;
    }
    const existing = this.cart.find(i => i.product.id === product.id);
    if (existing) {
      if (existing.quantity >= product.quantity) {
        this.snackBar.open('Cannot add more than available stock', 'Close', { duration: 3000 });
        return;
      }
      existing.quantity++;
      existing.subtotal = existing.quantity * existing.product.price;
    } else {
      this.cart.push({ product, quantity: 1, subtotal: product.price });
    }
  }

  updateQty(item: CartItem, qty: number): void {
    if (qty <= 0) { this.removeFromCart(item); return; }
    if (qty > item.product.quantity) {
      this.snackBar.open('Cannot exceed available stock', 'Close', { duration: 2000 });
      return;
    }
    item.quantity = qty;
    item.subtotal = qty * item.product.price;
  }

  removeFromCart(item: CartItem): void {
    this.cart = this.cart.filter(i => i !== item);
  }

  clearCart(): void {
    this.cart = [];
    this.selectedCustomer = null;
    this.discount = 0;
    this.paymentMethod = 'CASH';
    this.completedOrder = null;
  }

  get subtotal(): number {
    return this.cart.reduce((sum, i) => sum + i.subtotal, 0);
  }

  get tax(): number {
    return this.subtotal * 0.1;
  }

  get total(): number {
    return this.subtotal + this.tax - (this.discount || 0);
  }

  placeOrder(): void {
    if (!this.cart.length) {
      this.snackBar.open('Cart is empty', 'Close', { duration: 2000 });
      return;
    }
    this.loading = true;
    const request = {
      customerId: this.selectedCustomer?.id,
      items: this.cart.map(i => ({ productId: i.product.id, quantity: i.quantity })),
      paymentMethod: this.paymentMethod,
      discount: this.discount || 0
    };
    this.orderService.create(request).subscribe({
      next: res => {
        this.completedOrder = res.data;
        this.loading = false;
        this.snackBar.open('Order placed successfully!', 'Close', { duration: 3000 });
        this.cart = [];
        this.selectedCustomer = null;
        this.discount = 0;
      },
      error: err => {
        this.snackBar.open(err.error?.message || 'Failed to place order', 'Close', { duration: 4000 });
        this.loading = false;
      }
    });
  }

  newOrder(): void {
    this.completedOrder = null;
  }

  printReceipt(): void {
    if (!this.completedOrder) return;
    const w = window.open('', '_blank', 'width=400,height=600');
    if (!w) {
      this.snackBar.open('Allow popups to print receipt', 'Close', { duration: 3000 });
      return;
    }
    const c = this.company;
    const o = this.completedOrder;
    const widthClass = (c?.receiptPaperSize === '58mm') ? 'receipt-58' : (c?.receiptPaperSize === 'A4') ? 'receipt-a4' : 'receipt-80';
    w.document.write(`
<!DOCTYPE html><html><head><meta charset="utf-8"><title>Receipt #${o.id}</title>
<style>
  body { font-family: monospace; margin: 0; padding: 12px; }
  .receipt-58 { max-width: 58mm; }
  .receipt-80 { max-width: 80mm; }
  .receipt-a4 { max-width: 210mm; }
  .company-name { font-weight: bold; font-size: 1.1em; text-align: center; margin-bottom: 8px; }
  .company-detail { font-size: 0.85em; text-align: center; color: #444; margin: 2px 0; }
  .row { display: flex; justify-content: space-between; margin: 4px 0; }
  .total { font-weight: bold; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #000; }
  .footer { text-align: center; margin-top: 12px; font-size: 0.9em; }
</style></head><body class="${widthClass}">
  <div class="company-name">${c?.name || 'Receipt'}</div>
  ${c?.address ? `<div class="company-detail">${c.address}</div>` : ''}
  ${c?.phone ? `<div class="company-detail">${c.phone}</div>` : ''}
  ${c?.receiptHeaderText ? `<div class="company-detail">${c.receiptHeaderText}</div>` : ''}
  <div style="margin: 8px 0; border-bottom: 1px dashed #000;"></div>
  <div>Order #${o.id}</div>
  ${(o.items || []).map((i: { productName: string; quantity: number; subtotal: number }) =>
    `<div class="row"><span>${i.productName} x${i.quantity}</span><span>$${Number(i.subtotal).toFixed(2)}</span></div>`
  ).join('')}
  <div class="row"><span>Subtotal</span><span>$${Number(o.subtotal).toFixed(2)}</span></div>
  <div class="row"><span>Tax</span><span>$${Number(o.tax).toFixed(2)}</span></div>
  ${(o.discount || 0) > 0 ? `<div class="row"><span>Discount</span><span>-$${Number(o.discount).toFixed(2)}</span></div>` : ''}
  <div class="row total"><span>TOTAL</span><span>$${Number(o.total).toFixed(2)}</span></div>
  <div class="row"><span>Payment</span><span>${o.paymentMethod || ''}</span></div>
  ${c?.receiptFooterText ? `<div class="footer">${c.receiptFooterText}</div>` : ''}
</body></html>`);
    w.document.close();
    w.focus();
    setTimeout(() => { w.print(); w.close(); }, 250);
  }

  displayCustomer(customer: CustomerResponse | null): string {
    return customer?.name || '';
  }
}
