<div class="page-header">
  <h2>Orders</h2>
</div>

<mat-card class="card">
  <div *ngIf="loading" style="display:flex;justify-content:center;padding:48px"><mat-spinner diameter="40"></mat-spinner></div>
  <table mat-table [dataSource]="orders" *ngIf="!loading" class="full-width">
    <ng-container matColumnDef="id">
      <th mat-header-cell *matHeaderCellDef>#</th>
      <td mat-cell *matCellDef="let o">{{ o.id }}</td>
    </ng-container>
    <ng-container matColumnDef="customer">
      <th mat-header-cell *matHeaderCellDef>Customer</th>
      <td mat-cell *matCellDef="let o">{{ o.customerName || 'Walk-in' }}</td>
    </ng-container>
    <ng-container matColumnDef="cashier">
      <th mat-header-cell *matHeaderCellDef>Cashier</th>
      <td mat-cell *matCellDef="let o">{{ o.cashierUsername }}</td>
    </ng-container>
    <ng-container matColumnDef="items">
      <th mat-header-cell *matHeaderCellDef>Items</th>
      <td mat-cell *matCellDef="let o">{{ o.items?.length || 0 }}</td>
    </ng-container>
    <ng-container matColumnDef="total">
      <th mat-header-cell *matHeaderCellDef>Total</th>
      <td mat-cell *matCellDef="let o"><strong>${{ o.total | number:'1.2-2' }}</strong></td>
    </ng-container>
    <ng-container matColumnDef="payment">
      <th mat-header-cell *matHeaderCellDef>Payment</th>
      <td mat-cell *matCellDef="let o">{{ o.paymentMethod | titlecase }}</td>
    </ng-container>
    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let o">
        <mat-chip [class]="statusClass(o.status)">{{ o.status }}</mat-chip>
      </td>
    </ng-container>
    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef>Date</th>
      <td mat-cell *matCellDef="let o">{{ o.createdAt | date:'short' }}</td>
    </ng-container>
    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef class="text-right">Actions</th>
      <td mat-cell *matCellDef="let o" class="text-right">
        <button mat-icon-button (click)="toggleExpand(o)" matTooltip="View details">
          <mat-icon>{{ expandedOrder?.id === o.id ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
        <button mat-icon-button color="warn" *ngIf="isAdminOrManager && o.status !== 'CANCELLED'"
          (click)="cancelOrder(o)" matTooltip="Cancel">
          <mat-icon>cancel</mat-icon>
        </button>
      </td>
    </ng-container>
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="order-row" (click)="toggleExpand(row)"></tr>
    <tr class="mat-row" *matNoDataRow>
      <td class="mat-cell text-center" colspan="9" style="padding:32px">No orders found.</td>
    </tr>
  </table>

  <div *ngIf="expandedOrder" class="order-detail">
    <mat-divider></mat-divider>
    <div class="detail-header">
      <strong>Order #{{ expandedOrder.id }} â€” Details</strong>
      <button mat-icon-button (click)="expandedOrder = null"><mat-icon>close</mat-icon></button>
    </div>
    <table class="detail-table">
      <thead><tr><th>Product</th><th>SKU</th><th>Qty</th><th>Unit Price</th><th>Subtotal</th></tr></thead>
      <tbody>
        <tr *ngFor="let item of expandedOrder.items">
          <td>{{ item.productName }}</td>
          <td>{{ item.productSku }}</td>
          <td>{{ item.quantity }}</td>
          <td>${{ item.unitPrice | number:'1.2-2' }}</td>
          <td>${{ item.subtotal | number:'1.2-2' }}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr><td colspan="4" class="text-right">Subtotal</td><td>${{ expandedOrder.subtotal | number:'1.2-2' }}</td></tr>
        <tr><td colspan="4" class="text-right">Tax</td><td>${{ expandedOrder.tax | number:'1.2-2' }}</td></tr>
        <tr *ngIf="expandedOrder.discount > 0"><td colspan="4" class="text-right">Discount</td><td>-${{ expandedOrder.discount | number:'1.2-2' }}</td></tr>
        <tr class="total-row"><td colspan="4" class="text-right"><strong>TOTAL</strong></td><td><strong>${{ expandedOrder.total | number:'1.2-2' }}</strong></td></tr>
      </tfoot>
    </table>
  </div>

  <mat-paginator [length]="totalElements" [pageSize]="pageSize" [pageSizeOptions]="[10,20,50]"
    (page)="onPage($event)" showFirstLastButtons></mat-paginator>
</mat-card>
